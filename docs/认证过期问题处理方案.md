# è®¤è¯è¿‡æœŸé—®é¢˜å¤„ç†æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

### å…¸å‹é”™è¯¯æ—¥å¿—
```
index.ts:102 
 GET http://localhost:8000/api/v1/items?category_id=1&is_completed=false&sort_by=created_at&order=desc&limit=100 401 (Unauthorized)
items.ts:128 è·å–äº‹é¡¹åˆ—è¡¨å¤±è´¥: ApiError: ç”¨æˆ·æœªç™»å½•
    at fetchApi (index.ts:135:17)
    at async getItems (items.ts:118:22)
    at async useTaskData.ts:941:34
useTaskData.ts:959 è·å–åˆ†ç±»ä»»åŠ¡å¤±è´¥: ApiError: ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•
    at getItems (items.ts:132:15)
    at async useTaskData.ts:941:34
```

### é—®é¢˜ç°è±¡
1. **APIè¿”å›401çŠ¶æ€ç ** - ç”¨æˆ·è®¤è¯tokenå·²è¿‡æœŸ
2. **ç”¨æˆ·ä½“éªŒå·®** - éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½è·³è½¬åˆ°ç™»å½•é¡µ
3. **æ•°æ®ä¸¢å¤±** - ç¼“å­˜çš„ä»»åŠ¡æ•°æ®å¯èƒ½ä¸è¿‡æœŸçš„ç”¨æˆ·çŠ¶æ€ä¸ä¸€è‡´
4. **é‡å¤è¯·æ±‚** - åœ¨tokenè¿‡æœŸåå¯èƒ½äº§ç”Ÿå¤šä¸ªå¤±è´¥çš„APIè°ƒç”¨

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
- **JWT Tokenç”Ÿå‘½å‘¨æœŸæœ‰é™** - æœåŠ¡ç«¯è®¾ç½®çš„tokenæœ‰æ•ˆæœŸåˆ°æœŸ
- **å‰ç«¯çŠ¶æ€ç®¡ç†ä¸åŒæ­¥** - localStorageä¸­çš„tokenè¢«æ¸…ç†ï¼Œä½†åº”ç”¨çŠ¶æ€æœªåŠæ—¶æ›´æ–°
- **ç¼ºä¹å…¨å±€è®¤è¯çŠ¶æ€ç›‘å¬** - å„ä¸ªç»„ä»¶æ— æ³•æ„ŸçŸ¥è®¤è¯çŠ¶æ€å˜åŒ–

### å½±å“èŒƒå›´
- é¦–é¡µä»»åŠ¡åŠ è½½ (`useHomePageTasks`)
- æ—¶é—´è½´é¡µé¢ (`useTimelineTasks`) 
- é¡¹ç›®ç®¡ç†é¡µé¢ (`useProjectTasks`)
- æ‰€æœ‰éœ€è¦è®¤è¯çš„APIè°ƒç”¨

## âš™ï¸ å½“å‰å¤„ç†æ–¹å¼

### 1. APIå±‚é¢å¤„ç† (`src/api/index.ts`)

```typescript
case 401:
  // æœªæˆæƒï¼Œtokenè¿‡æœŸæˆ–æ— æ•ˆ
  localStorage.removeItem('access_token');
  localStorage.removeItem('user');
  localStorage.removeItem('appState');
  
  // è§¦å‘å…¨å±€ç™»å‡ºäº‹ä»¶
  window.dispatchEvent(new CustomEvent('auth:logout'));
  
  throw new ApiError(
    data.message || 'ç”¨æˆ·æœªç™»å½•',
    data.code || 401,
    response.status
  );
```

**åŠŸèƒ½**ï¼š
- æ¸…ç†æœ¬åœ°å­˜å‚¨çš„è®¤è¯ä¿¡æ¯
- å‘å‡ºå…¨å±€ç™»å‡ºäº‹ä»¶
- æŠ›å‡ºæ ‡å‡†åŒ–çš„APIé”™è¯¯

### 2. ä¸šåŠ¡å±‚é¢å¤„ç† (`src/hooks/useTaskData.ts`)

```typescript
} catch (err: unknown) {
  if (err instanceof ApiError && err.statusCode === 401) {
    // ç»™ç”¨æˆ·æ›´å‹å¥½çš„æç¤º
    setError('ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨é‡æ–°ç™»å½•...');
    // è§¦å‘é‡æ–°ç™»å½•æµç¨‹
    setTimeout(() => {
      window.location.href = '/login';
    }, 1500);
  } else {
    const errorMessage = err instanceof Error ? err.message : 'è·å–äº‹é¡¹å¤±è´¥';
    setError(errorMessage);
  }
}
```

**åŠŸèƒ½**ï¼š
- æä¾›å‹å¥½çš„ç”¨æˆ·æç¤º
- å»¶è¿Ÿè·³è½¬ç»™ç”¨æˆ·ååº”æ—¶é—´
- åŒºåˆ†401é”™è¯¯å’Œå…¶ä»–é”™è¯¯ç±»å‹

### 3. è®¤è¯å®ˆå« (`src/components/AuthGuard.tsx`)

```typescript
useEffect(() => {
  // åªæœ‰åœ¨åˆå§‹åŒ–åæ‰è¿›è¡Œè®¤è¯æ£€æŸ¥
  if (isInitialized && (!state.isAuthenticated || !state.user)) {
    console.log('ğŸ” AuthGuard: ç”¨æˆ·æœªè®¤è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
    navigate('/login', { replace: true });
  }
}, [isInitialized, state.isAuthenticated, state.user, navigate]);
```

**åŠŸèƒ½**ï¼š
- ä¿æŠ¤éœ€è¦è®¤è¯çš„é¡µé¢
- è‡ªåŠ¨é‡å®šå‘åˆ°ç™»å½•é¡µé¢
- é˜²æ­¢æœªè®¤è¯ç”¨æˆ·è®¿é—®å—ä¿æŠ¤èµ„æº

### 4. ç¼“å­˜æ¸…ç†æœºåˆ¶

```typescript
const handleAuthError = useCallback(() => {
  // æ¸…ç†timelineç¼“å­˜
  sessionStorage.removeItem('timeline-cache-metadata');
  Object.keys(sessionStorage).forEach(key => {
    if (key.startsWith('timeline-tasks-')) {
      sessionStorage.removeItem(key);
    }
  });
}, []);
```

**åŠŸèƒ½**ï¼š
- æ¸…ç†ä¸ç”¨æˆ·ç›¸å…³çš„ç¼“å­˜æ•°æ®
- é˜²æ­¢æ•°æ®æ³„éœ²å’ŒçŠ¶æ€æ··ä¹±

## âœ… ä¼˜åŠ¿

1. **å¤šå±‚é˜²æŠ¤** - APIå±‚ã€ä¸šåŠ¡å±‚ã€è·¯ç”±å±‚éƒ½æœ‰ç›¸åº”å¤„ç†
2. **ç”¨æˆ·å‹å¥½** - æä¾›æ˜ç¡®çš„é”™è¯¯æç¤ºå’Œè‡ªåŠ¨è·³è½¬
3. **æ•°æ®å®‰å…¨** - åŠæ—¶æ¸…ç†æ•æ„Ÿçš„è®¤è¯ä¿¡æ¯å’Œç¼“å­˜
4. **ç»Ÿä¸€å¤„ç†** - é€šè¿‡ApiErrorç±»ç»Ÿä¸€é”™è¯¯æ ¼å¼

## ğŸš€ ä¼˜åŒ–å»ºè®®

### é«˜ä¼˜å…ˆçº§ä¼˜åŒ–

#### 1. å®ç°å…¨å±€è®¤è¯çŠ¶æ€ç›‘å¬
```typescript
// åœ¨UserContextä¸­æ·»åŠ 
useEffect(() => {
  const handleGlobalLogout = () => {
    dispatch({ type: 'LOGOUT' });
    // å¯é€‰ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
    window.location.href = '/login';
  };

  window.addEventListener('auth:logout', handleGlobalLogout);
  
  return () => {
    window.removeEventListener('auth:logout', handleGlobalLogout);
  };
}, [dispatch]);
```

#### 2. æ·»åŠ Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
```typescript
export async function refreshToken(): Promise<boolean> {
  try {
    const refreshToken = localStorage.getItem('refresh_token');
    if (!refreshToken) return false;

    const response = await fetchApi<ApiResponse<LoginResponse>>('/auth/refresh', {
      method: 'POST',
      body: JSON.stringify({ refresh_token: refreshToken }),
    });

    if (response.code === 0 && response.data) {
      localStorage.setItem('access_token', response.data.access_token);
      return true;
    }
    return false;
  } catch (error) {
    return false;
  }
}
```

### ä¸­ä¼˜å…ˆçº§ä¼˜åŒ–

#### 3. å®ç°è¯·æ±‚é‡è¯•æœºåˆ¶
- åœ¨401é”™è¯¯æ—¶è‡ªåŠ¨å°è¯•åˆ·æ–°token
- åˆ·æ–°æˆåŠŸåé‡æ–°å‘èµ·åŸå§‹è¯·æ±‚
- é™åˆ¶é‡è¯•æ¬¡æ•°é˜²æ­¢æ— é™å¾ªç¯

#### 4. æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘æ§
- åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œè®¤è¯é”™è¯¯
- åœ¨ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨é‡è¯•
- æä¾›ç¦»çº¿çŠ¶æ€æç¤º

### ä½ä¼˜å…ˆçº§ä¼˜åŒ–

#### 5. å®ç°æ¸è¿›å¼é™çº§
- åœ¨è®¤è¯è¿‡æœŸæ—¶æ˜¾ç¤ºéƒ¨åˆ†ç¼“å­˜æ•°æ®
- æä¾›"ä»…æŸ¥çœ‹"æ¨¡å¼
- ä¼˜é›…çš„åŠŸèƒ½é™çº§ä½“éªŒ

#### 6. æ·»åŠ è®¤è¯çŠ¶æ€åˆ†æ
- è®°å½•tokenè¿‡æœŸé¢‘ç‡
- åˆ†æç”¨æˆ·ä¼šè¯æ¨¡å¼
- ä¼˜åŒ–tokenæœ‰æ•ˆæœŸç­–ç•¥

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å»ºè®®ç›‘æ§çš„å…³é”®æŒ‡æ ‡
1. **401é”™è¯¯é¢‘ç‡** - ç›‘æ§è®¤è¯è¿‡æœŸçš„å‘ç”Ÿé¢‘ç‡
2. **è‡ªåŠ¨é‡è¯•æˆåŠŸç‡** - è¯„ä¼°tokenåˆ·æ–°æœºåˆ¶æ•ˆæœ
3. **ç”¨æˆ·é‡æ–°ç™»å½•ç‡** - è¡¡é‡ç”¨æˆ·ä½“éªŒå½±å“
4. **ä¼šè¯æŒç»­æ—¶é•¿** - ä¼˜åŒ–tokenæœ‰æ•ˆæœŸè®¾ç½®

### æ—¥å¿—è®°å½•è¦ç‚¹
```typescript
// åœ¨401å¤„ç†æ—¶è®°å½•å…³é”®ä¿¡æ¯
console.error('è®¤è¯è¿‡æœŸ', {
  endpoint,
  timestamp: new Date().toISOString(),
  userId: getCurrentUserId(),
  sessionDuration: getSessionDuration(),
  retryAttempt: retryCount
});
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™401é”™è¯¯åé¡µé¢æ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Ÿ**
A: å¯èƒ½æ˜¯å¤šä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç›¸å…³çš„hookéƒ½æ­£ç¡®å¤„ç†äº†401é”™è¯¯ã€‚

**Q: æ¸…é™¤ç¼“å­˜åç”¨æˆ·æ•°æ®æ˜¯å¦ä¼šä¸¢å¤±ï¼Ÿ**
A: å½“å‰åªæ¸…ç†ä¼šè¯çº§ç¼“å­˜ï¼ˆsessionStorageï¼‰ï¼Œç”¨æˆ·çš„æŒä¹…åŒ–è®¾ç½®ä¸ä¼šä¸¢å¤±ã€‚

**Q: å¦‚ä½•æµ‹è¯•è®¤è¯è¿‡æœŸåœºæ™¯ï¼Ÿ**
A: å¯ä»¥æ‰‹åŠ¨åˆ é™¤localStorageä¸­çš„access_tokenï¼Œæˆ–è€…ä¿®æ”¹tokenä¸ºæ— æ•ˆå€¼è¿›è¡Œæµ‹è¯•ã€‚

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `src/api/index.ts` - APIé”™è¯¯å¤„ç†å’Œè®¤è¯æ‹¦æˆª
- `src/api/user.ts` - ç”¨æˆ·è®¤è¯ç›¸å…³API
- `src/hooks/useTaskData.ts` - ä¸šåŠ¡å±‚401é”™è¯¯å¤„ç†
- `src/context/UserContext.tsx` - ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†
- `src/components/AuthGuard.tsx` - è·¯ç”±å±‚è®¤è¯ä¿æŠ¤

---

**æœ€åæ›´æ–°**: 2024å¹´12æœˆ
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
**ç‰ˆæœ¬**: v1.0 