# é¡¹ç›®ç¼“å­˜æœºåˆ¶å®Œæ•´è¯´æ˜æ–‡æ¡£

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨äº†å¤šå±‚çº§ã€å¤šé¡µé¢çš„ç¼“å­˜æ¶æ„ï¼Œé€šè¿‡ `sessionStorage` å®ç°é«˜æ•ˆçš„æ•°æ®ç¼“å­˜å’Œé¡µé¢é—´æ•°æ®å…±äº«ã€‚ç¼“å­˜ç³»ç»ŸåŒ…å«ä¸¤å¤§æ ¸å¿ƒå­ç³»ç»Ÿï¼š

### ğŸ—‚ï¸ ä»»åŠ¡æ•°æ®ç¼“å­˜ç³»ç»Ÿ
è´Ÿè´£åŸå§‹ä»»åŠ¡æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†ï¼Œæ¶µç›–ä»¥ä¸‹æ ¸å¿ƒé¡µé¢ï¼š
- **é¡¹ç›®é¡µé¢** (`ProjectsPage`)ï¼šåˆ†ç±»é¡¹ç›®ä»»åŠ¡ç¼“å­˜
- **ä¸»é¡µ** (`HomePage`)ï¼šä»Šæ—¥ä»»åŠ¡ç¼“å­˜
- **æ—¶é—´è½´é¡µé¢** (`TimelinePage`)ï¼šæŒ‰æ—¥æœŸçš„ä»»åŠ¡ç¼“å­˜

### ğŸ¤– æ¨èç®—æ³•ç¼“å­˜ç³»ç»Ÿ
è´Ÿè´£æ¨èç»“æœçš„æ™ºèƒ½ç¼“å­˜ï¼Œé¿å…é‡å¤çš„AIè°ƒç”¨å’Œå¤æ‚è®¡ç®—ï¼š
- **æ¨èç»“æœç¼“å­˜**ï¼šç¼“å­˜AI/æœ¬åœ°æ¨èçš„è®¡ç®—ç»“æœ
- **æ™ºèƒ½å¤±æ•ˆæ£€æµ‹**ï¼šåŸºäºä»»åŠ¡æ•°æ®å“ˆå¸Œçš„å˜åŒ–æ£€æµ‹
- **è‡ªåŠ¨é™çº§æœºåˆ¶**ï¼šAIæ¨èå¤±è´¥æ—¶çš„æœ¬åœ°ç®—æ³•å…œåº•

## ğŸ¯ è®¾è®¡ç†å¿µ

### 1. ç¼“å­˜åˆ†å±‚ç­–ç•¥
- **ä»»åŠ¡æ•°æ®å±‚**ï¼šåŸå§‹æ•°æ®çš„å¿«é€Ÿè®¿é—®ç¼“å­˜ï¼ˆ15åˆ†é’Ÿè¿‡æœŸï¼‰
- **æ¨èè®¡ç®—å±‚**ï¼šè¡ç”Ÿæ•°æ®çš„æ™ºèƒ½ç¼“å­˜ï¼ˆ10åˆ†é’Ÿè¿‡æœŸ + æ•°æ®å˜åŒ–æ£€æµ‹ï¼‰
- **ç”¨æˆ·ä½“éªŒå±‚**ï¼šå³æ—¶å“åº”çš„ç•Œé¢çŠ¶æ€ç¼“å­˜

### 2. ç¼“å­˜å…±äº«ç­–ç•¥
- **ä¸»é¡µ-æ—¶é—´è½´å…±äº«**ï¼šä½¿ç”¨ç›¸åŒçš„ç¼“å­˜æ ¼å¼(`timeline-tasks-`å‰ç¼€)å®ç°æ•°æ®å…±äº«
- **é¡¹ç›®é¡µé¢ç‹¬ç«‹**ï¼šä½¿ç”¨ç‹¬ç«‹çš„ç¼“å­˜é”®(`project-category-tasks-`å‰ç¼€)é¿å…å†²çª
- **æ¨èæ•°æ®ç‹¬ç«‹**ï¼šä½¿ç”¨ä¸“ç”¨ç¼“å­˜é”®(`homepage-recommendations`)ç®¡ç†æ¨èç»“æœ

### 3. ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ä»»åŠ¡ç¼“å­˜**ï¼š15åˆ†é’Ÿè¿‡æœŸæ—¶é—´ï¼Œä»Šæ—¥æ•°æ®æ°¸ä¸è¿‡æœŸ
- **æ¨èç¼“å­˜**ï¼š10åˆ†é’Ÿè¿‡æœŸæ—¶é—´ + æ™ºèƒ½æ£€æµ‹æœºåˆ¶
- **é¡µé¢ç„¦ç‚¹åˆ·æ–°**ï¼šé¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶è‡ªåŠ¨å°è¯•ç¼“å­˜åˆ·æ–°
- **æ™ºèƒ½é™çº§**ï¼šç¼“å­˜å¤±æ•ˆæ—¶è‡ªåŠ¨å›é€€åˆ°APIè°ƒç”¨

## ğŸ“Š ä»»åŠ¡æ•°æ®ç¼“å­˜ç³»ç»Ÿè¯¦è§£

### 1. ä¸»é¡µ (HomePage) ä»»åŠ¡ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜èŒƒå›´
- **ä»Šæ—¥ä»»åŠ¡ç¼“å­˜**ï¼šä¸æ—¶é—´è½´é¡µé¢å…±äº«ä»Šæ—¥æ•°æ®
- **ç¼“å­˜é”®æ ¼å¼**ï¼šä½¿ç”¨æ—¶é—´è½´çš„ç¼“å­˜æ ¼å¼å®ç°æ•°æ®å…±äº«

#### ç¼“å­˜é”®å‘½åè§„èŒƒ
```typescript
// ä½¿ç”¨æ—¶é—´è½´çš„ç¼“å­˜æ ¼å¼å®ç°æ•°æ®å…±äº«
const todayCacheKey = `timeline-tasks-${format(new Date(), 'yyyy-MM-dd')}`;
const cacheMetadataKey = 'timeline-cache-metadata';
```

#### å·¥ä½œæµç¨‹
```typescript
// é¡µé¢åˆå§‹åŒ–æµç¨‹
useEffect(() => {
  // 1. ä¼˜å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½
  const refreshed = refreshFromCache();
  if (!refreshed) {
    // 2. ç¼“å­˜ä¸å¯ç”¨æ—¶è°ƒç”¨API
    loadTodayTasks();
  }
}, [loadTodayTasks, refreshFromCache]);
```

#### ç‰¹è‰²åŠŸèƒ½
- **ä»»åŠ¡å®ŒæˆçŠ¶æ€åŒæ­¥**ï¼šå®Œæˆä»»åŠ¡åä»æ¨èåˆ—è¡¨è‡ªåŠ¨ç§»é™¤
- **çƒŸèŠ±ç‰¹æ•ˆç¼“å­˜**ï¼šå®Œæˆä»»åŠ¡æ—¶çš„ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **ä¸æ¨èç³»ç»Ÿè”åŠ¨**ï¼šä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥æ¨èç¼“å­˜æ›´æ–°

### 2. æ—¶é—´è½´é¡µé¢ (TimelinePage) ä»»åŠ¡ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜èŒƒå›´
- **æŒ‰æ—¥æœŸåˆ†ç»„ç¼“å­˜**ï¼šæ¯ä¸ªæ—¥æœŸç‹¬ç«‹ç¼“å­˜ä»»åŠ¡æ•°æ®
- **æœªå®Œæˆä»»åŠ¡**ï¼šæ´»è·ƒä»»åŠ¡çš„å®æ—¶ç¼“å­˜
- **å·²å®Œæˆä»»åŠ¡**ï¼šå†å²å®Œæˆæ•°æ®çš„ç¼“å­˜

#### ç¼“å­˜é”®å‘½åè§„èŒƒ
```typescript
// æŒ‰æ—¥æœŸç¼“å­˜ä»»åŠ¡æ•°æ®
const dateKey = format(selectedDate, 'yyyy-MM-dd');
const cacheKey = `timeline-tasks-${dateKey}`;
const metadataKey = 'timeline-cache-metadata';
```

#### æ™ºèƒ½ç¼“å­˜æ›´æ–°
```typescript
// ä»»åŠ¡å®ŒæˆçŠ¶æ€æ›´æ–°æ—¶çš„ç¼“å­˜åŒæ­¥
const handleComplete = async (id: string, e: React.MouseEvent) => {
  // 1. è°ƒç”¨APIæ›´æ–°çŠ¶æ€
  await toggleTaskCompletionForTimeline(id, task.completed);
  
  // 2. æ›´æ–°æœ¬åœ°ç¼“å­˜
  const updatedTasks = currentAllTasks.map(apiTask => {
    if (apiTask.id === id) {
      return { ...apiTask, status_id: apiTask.status_id === 3 ? 1 : 3 };
    }
    return apiTask;
  });
  
  // 3. åŒæ­¥åˆ°sessionStorage
  sessionStorage.setItem(`timeline-tasks-${dateKey}`, JSON.stringify(updatedTasks));
  
  // 4. é€šçŸ¥æ¨èç³»ç»Ÿæ›´æ–°
  window.dispatchEvent(new CustomEvent('taskCacheUpdated', {
    detail: { action: 'update', taskId: id }
  }));
  
  // 5. åˆ·æ–°é¡µé¢æ•°æ®
  refreshFromCache();
};
```

#### æ—¥æœŸåˆ‡æ¢ä¼˜åŒ–
- **é¢„æµ‹æ€§åŠ è½½**ï¼šåˆ‡æ¢æ—¥æœŸæ—¶ä¼˜å…ˆæ£€æŸ¥ç¼“å­˜
- **å‘¨è§†å›¾æ”¯æŒ**ï¼šå‘¨è§†å›¾æ•°æ®çš„æ‰¹é‡ç¼“å­˜ç®¡ç†
- **ä»Šæ—¥æ ‡è®°**ï¼šç‰¹æ®Šå¤„ç†ä»Šæ—¥æ•°æ®çš„ç¼“å­˜ç­–ç•¥

### 3. é¡¹ç›®é¡µé¢ (ProjectsPage) ä»»åŠ¡ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜èŒƒå›´
- **åˆ†ç±»ä»»åŠ¡ç¼“å­˜**ï¼šæŒ‰category_idåˆ†ç»„çš„é¡¹ç›®ä»»åŠ¡
- **é¡¹ç›®è¿›åº¦ç¼“å­˜**ï¼šé¡¹ç›®å®Œæˆåº¦å’Œç»Ÿè®¡ä¿¡æ¯
- **é«˜ä¼˜å…ˆçº§ä»»åŠ¡ç¼“å­˜**ï¼šé‡è¦ä»»åŠ¡çš„å¿«é€Ÿè®¿é—®

#### ç¼“å­˜é”®å‘½åè§„èŒƒ
```typescript
// é¡¹ç›®ç›¸å…³ç¼“å­˜é”®
const PROJECT_CACHE_PREFIX = 'project-category-tasks-';
const PROJECT_CACHE_METADATA_KEY = 'project-cache-metadata';
const CACHE_EXPIRE_TIME = 15 * 60 * 1000; // 15åˆ†é’Ÿ
const MAX_CACHE_ENTRIES = 10; // æœ€å¤§ç¼“å­˜æ¡ç›®
```

#### ç¼“å­˜ç®¡ç†ç­–ç•¥
- **LRUæ·˜æ±°**ï¼šæœ€å¤šç¼“å­˜10ä¸ªåˆ†ç±»ï¼Œè¶…å‡ºæ—¶æ·˜æ±°æœ€æ—§çš„
- **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜æ¡ç›®
- **åˆ†ç±»éš”ç¦»**ï¼šä¸åŒåˆ†ç±»çš„æ•°æ®å®Œå…¨éš”ç¦»

## ğŸ¤– æ¨èç®—æ³•ç¼“å­˜ç³»ç»Ÿè¯¦è§£

### 1. æ¨èç¼“å­˜æ•°æ®ç»“æ„

```typescript
interface RecommendationCache {
  recommendations: Item[];        // æ¨èç»“æœ
  method: 'ai' | 'local';        // æ¨èç®—æ³•ç±»å‹
  taskHash: string;              // åŸºç¡€ä»»åŠ¡æ•°æ®å“ˆå¸Œ
  timestamp: number;             // ç¼“å­˜æ—¶é—´æˆ³
  userContext?: any;             // ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯
  count: number;                 // æ¨èæ•°é‡
}
```

### 2. æ™ºèƒ½å¤±æ•ˆæ£€æµ‹æœºåˆ¶

#### ä»»åŠ¡æ•°æ®å“ˆå¸Œç®—æ³•
```typescript
export const generateTaskHash = (tasks: Item[]): string => {
  if (!tasks || tasks.length === 0) {
    return 'empty';
  }
  
  const hashData = tasks
    .map(task => `${task.id}-${task.status_id}-${task.priority}-${task.updated_at}`)
    .sort() // æ’åºç¡®ä¿ä¸€è‡´æ€§
    .join('|');
  
  return btoa(hashData).substring(0, 16); // ç®€åŒ–å“ˆå¸Œ
};
```

#### æ™ºèƒ½æ£€æµ‹æ¡ä»¶
```typescript
export const shouldUpdateRecommendations = (
  tasks: Item[], 
  method: 'ai' | 'local',
  userContext?: any
): boolean => {
  const cached = getRecommendationCache();
  
  if (!cached) {
    console.log('ğŸ“‹ æ²¡æœ‰æ¨èç¼“å­˜ï¼Œéœ€è¦ç”Ÿæˆ');
    return true;
  }
  
  const currentHash = generateTaskHash(tasks);
  
  // æ£€æŸ¥ä»»åŠ¡æ•°æ®æ˜¯å¦å˜åŒ–
  if (cached.taskHash !== currentHash) {
    console.log('ğŸ“‹ ä»»åŠ¡æ•°æ®å·²å˜åŒ–ï¼Œéœ€è¦æ›´æ–°æ¨è');
    return true;
  }
  
  // æ£€æŸ¥æ¨èæ–¹æ³•æ˜¯å¦å˜åŒ–
  if (cached.method !== method) {
    console.log('ğŸ”„ æ¨èæ–¹æ³•å·²å˜åŒ–ï¼Œéœ€è¦æ›´æ–°æ¨è');
    return true;
  }
  
  // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
  if (Date.now() - cached.timestamp > RECOMMENDATION_CACHE_EXPIRE) {
    console.log('â° æ¨èç¼“å­˜å·²è¿‡æœŸï¼Œéœ€è¦æ›´æ–°');
    return true;
  }
  
  console.log('ğŸ’¾ æ¨èç¼“å­˜æœ‰æ•ˆï¼Œå¤ç”¨ç°æœ‰ç»“æœ');
  return false;
};
```

### 3. æ¨èç”Ÿæˆä¸ç¼“å­˜ç®¡ç†

#### é˜²å¹¶å‘è°ƒç”¨æœºåˆ¶
```typescript
// å…¨å±€æ¨èçŠ¶æ€ç®¡ç†
let isGeneratingRecommendations = false;
let lastRecommendationPromise: Promise<Item[]> | null = null;

const getRecommendationsWithCache = async (tasks: Item[]): Promise<Item[]> => {
  // å¦‚æœæ­£åœ¨ç”Ÿæˆæ¨èï¼Œå¤ç”¨å½“å‰Promise
  if (isGeneratingRecommendations && lastRecommendationPromise) {
    console.log('ğŸ”„ æ¨èæ­£åœ¨ç”Ÿæˆä¸­ï¼Œå¤ç”¨å½“å‰è¯·æ±‚');
    return lastRecommendationPromise;
  }
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
  if (!shouldUpdateRecommendations(tasks, 'ai')) {
    const cached = getRecommendationCache();
    console.log('ğŸ’¾ ä½¿ç”¨ç¼“å­˜çš„æ¨èç»“æœ');
    return cached!.recommendations;
  }
  
  // ç”Ÿæˆæ–°æ¨è
  isGeneratingRecommendations = true;
  lastRecommendationPromise = generateNewRecommendations(tasks);
  
  try {
    const result = await lastRecommendationPromise;
    cacheRecommendations(result, tasks, 'ai');
    return result;
  } finally {
    isGeneratingRecommendations = false;
    lastRecommendationPromise = null;
  }
};
```

### 4. AIæ¨èä¼˜é›…é™çº§æœºåˆ¶

```typescript
const generateNewRecommendations = async (tasks: Item[]): Promise<Item[]> => {
  const isTestUser = checkIsTestUser();
  
  try {
    if (!isTestUser) {
      // æ­£å¼ç”¨æˆ·ä¼˜å…ˆä½¿ç”¨AIæ¨è
      console.log('ğŸ¤– å°è¯•ä½¿ç”¨AIæ¨è');
      const aiRecommendations = await recommendationService.getRecommendations(tasks, {
        method: 'ai',
        count: 3
      });
      
      console.log('âœ… AIæ¨èç”ŸæˆæˆåŠŸ');
      return aiRecommendations;
    }
  } catch (error) {
    console.log('ğŸ”„ AIæ¨èå¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°æ¨è');
  }
  
  // é™çº§åˆ°æœ¬åœ°æ¨è
  console.log('ğŸ’» ä½¿ç”¨æœ¬åœ°æ¨èç®—æ³•');
  const localRecommendations = await recommendationService.getRecommendations(tasks, {
    method: 'local',
    count: 3
  });
  
  return localRecommendations;
};
```

## ğŸ”„ è·¨é¡µé¢æ•°æ®å…±äº«æœºåˆ¶

### 1. ä¸»é¡µ-æ—¶é—´è½´æ•°æ®å…±äº«

æ ¹æ®è®°å¿†[[memory:1335130]]ï¼Œå·²æˆåŠŸå®ç°äº†é¦–é¡µå’Œæ—¶é—´è½´é¡µé¢çš„ä»»åŠ¡ç¼“å­˜å…±äº«æœºåˆ¶ï¼š

```typescript
// å…±äº«ç¼“å­˜æ ¼å¼é…ç½®
const SHARED_CACHE_PREFIX = 'timeline-tasks-';
const SHARED_METADATA_KEY = 'timeline-cache-metadata';

// ä¸»é¡µä½¿ç”¨æ—¶é—´è½´çš„ç¼“å­˜æ ¼å¼
const todayKey = format(new Date(), 'yyyy-MM-dd');
const todayCacheKey = `${SHARED_CACHE_PREFIX}${todayKey}`;
```

#### å…±äº«ä¼˜åŠ¿
- **å‡å°‘APIè°ƒç”¨**ï¼šé¦–é¡µæ£€æŸ¥æ—¶é—´è½´ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚ä»Šæ—¥ä»»åŠ¡
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¸¤ä¸ªé¡µé¢çœ‹åˆ°ç›¸åŒçš„ä»Šæ—¥ä»»åŠ¡çŠ¶æ€
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¡µé¢åˆ‡æ¢æ—¶æ— éœ€é‡æ–°åŠ è½½ç›¸åŒæ•°æ®

### 2. æ¨èç³»ç»Ÿä¸ä»»åŠ¡ç¼“å­˜è”åŠ¨

```typescript
// ç›‘å¬ä»»åŠ¡ç¼“å­˜æ›´æ–°äº‹ä»¶
useEffect(() => {
  const handleTaskCacheUpdated = (event: CustomEvent) => {
    console.log('ğŸ“¢ æ”¶åˆ°ä»»åŠ¡ç¼“å­˜æ›´æ–°äº‹ä»¶', event.detail);
    
    // è·å–æ›´æ–°åçš„ä»»åŠ¡æ•°æ®
    const updatedTasks = getTodayTasksFromCache();
    if (updatedTasks) {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ¨è
      if (shouldUpdateRecommendations(updatedTasks, 'ai')) {
        console.log('ğŸ”„ ä»»åŠ¡æ•°æ®å˜åŒ–ï¼Œæ›´æ–°æ¨è');
        generateNewRecommendations(updatedTasks);
      } else {
        console.log('ğŸ’¾ æ¨èç¼“å­˜ä»ç„¶æœ‰æ•ˆ');
      }
    }
  };

  window.addEventListener('taskCacheUpdated', handleTaskCacheUpdated as EventListener);
  
  return () => {
    window.removeEventListener('taskCacheUpdated', handleTaskCacheUpdated as EventListener);
  };
}, []);
```

### 3. ç¼“å­˜æ•°æ®æ ¼å¼ç»Ÿä¸€

```typescript
// ä»»åŠ¡ç¼“å­˜æ•°æ®æ ¼å¼
interface CachedTaskData {
  tasks: Item[]; // APIè¿”å›çš„åŸå§‹æ•°æ®æ ¼å¼
  timestamp: number; // ç¼“å­˜æ—¶é—´æˆ³
  metadata?: {
    totalCount: number;
    lastUpdate: string;
  };
}

// æ¨èç¼“å­˜æ•°æ®æ ¼å¼
interface RecommendationCache {
  recommendations: Item[]; // æ¨èç»“æœ
  method: 'ai' | 'local'; // æ¨èæ–¹æ³•
  taskHash: string; // ä»»åŠ¡æ•°æ®å“ˆå¸Œ
  timestamp: number; // ç¼“å­˜æ—¶é—´æˆ³
  userContext?: any; // ç”¨æˆ·ä¸Šä¸‹æ–‡
  count: number; // æ¨èæ•°é‡
}
```

## ğŸ› ï¸ æ ¸å¿ƒå®ç°æœºåˆ¶

### 1. useCallback å‡½æ•°ä¼˜åŒ–

æ‰€æœ‰å…³é”®ç¼“å­˜å‡½æ•°éƒ½ä½¿ç”¨ `useCallback` åŒ…è£…ï¼Œé¿å…æ— é™é‡æ¸²æŸ“ï¼š

```typescript
// é¡¹ç›®é¡µé¢
const loadCategoryTasks = useCallback(async (categoryId: string, forceReload = false) => {
  // ç¼“å­˜é€»è¾‘å®ç°
}, []);

// ä¸»é¡µ
const refreshFromCache = useCallback(() => {
  // ç¼“å­˜åˆ·æ–°é€»è¾‘
}, []);

// æ—¶é—´è½´é¡µé¢
const loadTasksByDate = useCallback(async (date: Date) => {
  // æŒ‰æ—¥æœŸåŠ è½½ç¼“å­˜é€»è¾‘
}, []);

// æ¨èç³»ç»Ÿ
const getRecommendationsWithCache = useCallback(async (tasks: Item[]) => {
  // æ¨èç¼“å­˜é€»è¾‘
}, []);
```

### 2. é¡µé¢ç”Ÿå‘½å‘¨æœŸç›‘å¬

ç»Ÿä¸€çš„é¡µé¢ç„¦ç‚¹å’Œå¯è§æ€§ç›‘å¬ï¼š

```typescript
useEffect(() => {
  const handleFocus = () => {
    console.log('é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œå°è¯•åˆ·æ–°ç¼“å­˜');
    const refreshed = refreshFromCache();
    if (!refreshed) {
      // ç¼“å­˜å¤±æ•ˆæ—¶é‡æ–°åŠ è½½
      loadData();
    }
  };

  const handleVisibilityChange = () => {
    if (!document.hidden) {
      const refreshed = refreshFromCache();
      if (!refreshed) {
        loadData();
      }
    }
  };

  window.addEventListener('focus', handleFocus);
  document.addEventListener('visibilitychange', handleVisibilityChange);

  return () => {
    window.removeEventListener('focus', handleFocus);
    document.removeEventListener('visibilitychange', handleVisibilityChange);
  };
}, [refreshFromCache, loadData]);
```

### 3. é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥

```typescript
const safeCacheOperation = (operation: () => void, fallback?: () => void) => {
  try {
    operation();
  } catch (error) {
    console.error('ç¼“å­˜æ“ä½œå¤±è´¥:', error);
    // è‡ªåŠ¨é™çº§åˆ°APIè°ƒç”¨
    fallback?.();
  }
};
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

### 1. APIè°ƒç”¨å‡å°‘å¯¹æ¯”
| ç¼“å­˜ç±»å‹ | ä¼˜åŒ–å‰è°ƒç”¨é¢‘ç‡ | ä¼˜åŒ–åè°ƒç”¨é¢‘ç‡ | æ”¹å–„å¹…åº¦ |
|---------|---------------|---------------|----------|
| ä»»åŠ¡æ•°æ® | æ¯æ¬¡é¡µé¢åˆ‡æ¢ | 15åˆ†é’Ÿå†…å¤ç”¨ | **å‡å°‘75%** |
| AIæ¨è | æ¯æ¬¡ä»»åŠ¡å˜åŒ– | æ™ºèƒ½æ£€æµ‹æ›´æ–° | **å‡å°‘90%** |
| æœ¬åœ°æ¨è | æ¯æ¬¡é¡µé¢åˆ·æ–° | ä»»åŠ¡ä¸å˜æ—¶å¤ç”¨ | **å‡å°‘85%** |

### 2. ç”¨æˆ·ä½“éªŒæå‡
- **åŠ è½½æ—¶é—´**ï¼šç¼“å­˜å‘½ä¸­æ—¶é¡µé¢åŠ è½½æ—¶é—´ < 100ms
- **ç½‘ç»œä¾èµ–**ï¼šç¦»çº¿æƒ…å†µä¸‹ä»å¯æµè§ˆç¼“å­˜æ•°æ®
- **çŠ¶æ€ä¿æŒ**ï¼šé¡µé¢åˆ‡æ¢æ—¶ä¿æŒç”¨æˆ·æ“ä½œçŠ¶æ€
- **æ¨èè´¨é‡**ï¼šAIæ¨èå¤±è´¥æ—¶æ— ç¼é™çº§åˆ°æœ¬åœ°ç®—æ³•

### 3. ç³»ç»Ÿèµ„æºä¼˜åŒ–
- **å†…å­˜ç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸç¼“å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼
- **å®¹é‡é™åˆ¶**ï¼šå„é¡µé¢è®¾ç½®åˆç†çš„ç¼“å­˜ä¸Šé™
- **è®¡ç®—èµ„æº**ï¼šé¿å…é‡å¤çš„æ¨èç®—æ³•è®¡ç®—
- **ç½‘ç»œå¸¦å®½**ï¼šå¤§å¹…å‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨

## âš¡ å…³é”®é—®é¢˜è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ äº‹é¡¹åç«‹å³æ˜¾ç¤ºé—®é¢˜

#### é—®é¢˜æè¿°
åœ¨ä½¿ç”¨å¿«é€Ÿæ·»åŠ ç»„ä»¶(`TaskAddDrawer`)æˆ–å®Œæ•´æ–°å»ºä»»åŠ¡é¡µé¢(`NewTaskPage`)æ·»åŠ ä»»åŠ¡æˆåŠŸåï¼Œæ–°ä»»åŠ¡æœªèƒ½ç«‹å³åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°ã€‚

#### æ ¹æœ¬åŸå› 
- **ç¼“å­˜æ›´æ–°ä¸åŒæ­¥**ï¼šç»„ä»¶æ·»åŠ ä»»åŠ¡åä»…è°ƒç”¨APIï¼ŒæœªåŒæ­¥æ›´æ–°æœ¬åœ°ç¼“å­˜
- **é¡µé¢æ— æ„ŸçŸ¥**ï¼šå½“å‰é¡µé¢æ— æ³•æ„ŸçŸ¥å…¶ä»–ç»„ä»¶çš„æ•°æ®å˜æ›´
- **æ•°æ®æºä¸ä¸€è‡´**ï¼šé¡µé¢æ˜¾ç¤ºçš„æ•°æ®æ¥è‡ªç¼“å­˜ï¼Œè€Œæ–°æ•°æ®ä»…å­˜åœ¨äºåç«¯

#### å®Œæ•´è§£å†³æ–¹æ¡ˆ

##### æ­¥éª¤1ï¼šç»„ä»¶å†…ç¼“å­˜åŒæ­¥
```typescript
// TaskAddDrawer.tsx ä¸­çš„å®ç°
const handleAddTask = async () => {
  try {
    // 1. è°ƒç”¨APIåˆ›å»ºä»»åŠ¡
    const result = await createItem(taskData);
    
    // 2. æ›´æ–°ä»»åŠ¡ç¼“å­˜
    const today = new Date().toISOString().split('T')[0];
    const cacheKey = `timeline-tasks-${today}`;
    const existingCache = sessionStorage.getItem(cacheKey);
    
    if (existingCache) {
      const cachedTasks = JSON.parse(existingCache);
      const updatedTasks = [...cachedTasks, result];
      sessionStorage.setItem(cacheKey, JSON.stringify(updatedTasks));
      
      // æ›´æ–°ç¼“å­˜å…ƒæ•°æ®
      const metadataKey = 'timeline-cache-metadata';
      const metadata = sessionStorage.getItem(metadataKey);
      if (metadata) {
        const parsed = JSON.parse(metadata);
        parsed[today] = Date.now();
        sessionStorage.setItem(metadataKey, JSON.stringify(parsed));
      }
    }
    
    // 3. æ¸…ç†æ¨èç¼“å­˜ï¼ˆæ–°ä»»åŠ¡ä¼šå½±å“æ¨èç»“æœï¼‰
    clearRecommendationCache();
    
    // 4. å‘é€å…¨å±€äº‹ä»¶é€šçŸ¥é¡µé¢åˆ·æ–°
    window.dispatchEvent(new CustomEvent('taskCacheUpdated', {
      detail: { action: 'add', taskId: result.id, taskTitle: result.title }
    }));
    
  } catch (error) {
    console.error('æ·»åŠ ä»»åŠ¡å¤±è´¥:', error);
  }
};
```

##### æ­¥éª¤2ï¼šé¡µé¢äº‹ä»¶ç›‘å¬
```typescript
// HomePage.tsx ä¸­çš„å®ç°
useEffect(() => {
  const handleTaskCacheUpdated = (event: CustomEvent) => {
    console.log('ğŸ“¢ æ”¶åˆ°ä»»åŠ¡ç¼“å­˜æ›´æ–°äº‹ä»¶', event.detail);
    
    // åˆ·æ–°ä»»åŠ¡æ•°æ®
    const refreshed = refreshFromCache();
    if (!refreshed) {
      console.log('ğŸ“¡ ç¼“å­˜åˆ·æ–°å¤±è´¥ï¼Œé‡æ–°åŠ è½½æ•°æ®');
      loadTodayTasks();
    }
    
    // é‡æ–°ç”Ÿæˆæ¨èï¼ˆæ–°ä»»åŠ¡ä¼šå½±å“æ¨èç»“æœï¼‰
    if (todayTasks.length > 0) {
      generateRecommendations(todayTasks);
    }
  };

  window.addEventListener('taskCacheUpdated', handleTaskCacheUpdated as EventListener);
  
  return () => {
    window.removeEventListener('taskCacheUpdated', handleTaskCacheUpdated as EventListener);
  };
}, [refreshFromCache, loadTodayTasks, todayTasks]);
```

#### å®æ–½æ•ˆæœ
- âœ… **å³æ—¶æ˜¾ç¤º**ï¼šæ·»åŠ ä»»åŠ¡åç«‹å³åœ¨å½“å‰é¡µé¢æ˜¾ç¤º
- âœ… **æ¨èæ›´æ–°**ï¼šæ–°ä»»åŠ¡è‡ªåŠ¨å½±å“æ¨èç»“æœ
- âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šæ‰€æœ‰é¡µé¢çœ‹åˆ°ç›¸åŒçš„æœ€æ–°æ•°æ®
- âœ… **æ— éœ€åˆ·æ–°**ï¼šç”¨æˆ·æ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ä¸å¿…è¦çš„APIé‡å¤è°ƒç”¨

### 2. æ¨èç¼“å­˜ä¸ä»»åŠ¡ç¼“å­˜è”åŠ¨ä¼˜åŒ–

#### æ™ºèƒ½è”åŠ¨æœºåˆ¶
```typescript
// ä»»åŠ¡çŠ¶æ€å˜æ›´æ—¶çš„æ¨èç¼“å­˜å¤„ç†
const handleTaskStatusChange = (taskId: string, newStatus: number) => {
  // 1. æ›´æ–°ä»»åŠ¡ç¼“å­˜
  updateTaskCache(taskId, { status_id: newStatus });
  
  // 2. æ£€æŸ¥æ¨èç¼“å­˜æ˜¯å¦éœ€è¦æ›´æ–°
  const currentTasks = getTasksFromCache();
  if (shouldUpdateRecommendations(currentTasks, 'ai')) {
    console.log('ğŸ”„ ä»»åŠ¡çŠ¶æ€å˜åŒ–ï¼Œæ¸…ç†æ¨èç¼“å­˜');
    clearRecommendationCache();
  }
  
  // 3. å‘é€è”åŠ¨äº‹ä»¶
  window.dispatchEvent(new CustomEvent('taskCacheUpdated', {
    detail: { action: 'statusChange', taskId, newStatus }
  }));
};
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•æ¸…å•
- [x] **ä¸»é¡µ-æ—¶é—´è½´æ•°æ®å…±äº«**ï¼šåˆ‡æ¢é¡µé¢æ—¶æ•°æ®ä¸€è‡´æ€§
- [x] **ç¼“å­˜è¿‡æœŸå¤„ç†**ï¼š15åˆ†é’Ÿåè‡ªåŠ¨é‡æ–°åŠ è½½
- [x] **é¡¹ç›®åˆ†ç±»åˆ‡æ¢**ï¼šåˆ†ç±»ç¼“å­˜æ­£å¸¸å·¥ä½œ
- [x] **ä»»åŠ¡å®ŒæˆçŠ¶æ€åŒæ­¥**ï¼šçŠ¶æ€å˜æ›´åç¼“å­˜åŠæ—¶æ›´æ–°
- [x] **é¡µé¢ç„¦ç‚¹åˆ·æ–°**ï¼šåå°åˆ‡æ¢åæ•°æ®åˆ·æ–°
- [x] **ç½‘ç»œå¼‚å¸¸å¤„ç†**ï¼šç¦»çº¿çŠ¶æ€ä¸‹çš„ç¼“å­˜é™çº§
- [x] **æ¨èæ™ºèƒ½æ£€æµ‹**ï¼šä»»åŠ¡å˜åŒ–æ—¶æ¨èè‡ªåŠ¨æ›´æ–°
- [x] **AIæ¨èé™çº§**ï¼šAIå¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨æœ¬åœ°ç®—æ³•
- [x] **å¹¶å‘è°ƒç”¨å¤„ç†**ï¼šé˜²æ­¢é‡å¤çš„æ¨èç”Ÿæˆ

### 2. æ€§èƒ½æµ‹è¯•æŒ‡æ ‡
- [x] **ä»»åŠ¡ç¼“å­˜å‘½ä¸­ç‡** > 80%
- [x] **æ¨èç¼“å­˜å‘½ä¸­ç‡** > 85%
- [x] **é¡µé¢åŠ è½½æ—¶é—´** < 200ms (ç¼“å­˜å‘½ä¸­æ—¶)
- [x] **å†…å­˜ä½¿ç”¨ç¨³å®š**ï¼šé•¿æ—¶é—´ä½¿ç”¨æ— å†…å­˜æ³„æ¼
- [x] **APIè°ƒç”¨é¢‘ç‡**ï¼šç›¸æ¯”æ— ç¼“å­˜ç‰ˆæœ¬å‡å°‘80%
- [x] **AIè°ƒç”¨é¢‘ç‡**ï¼šç›¸æ¯”æ— ç¼“å­˜ç‰ˆæœ¬å‡å°‘90%

### 3. è¾¹ç•Œæƒ…å†µæµ‹è¯•
- [x] **å­˜å‚¨ç©ºé—´æ»¡**ï¼šsessionStorageå®¹é‡é™åˆ¶å¤„ç†
- [x] **æ•°æ®æŸå**ï¼šç¼“å­˜æ•°æ®æ ¼å¼é”™è¯¯çš„æ¢å¤
- [x] **å¹¶å‘è®¿é—®**ï¼šå¤šæ ‡ç­¾é¡µåŒæ—¶æ“ä½œçš„æ•°æ®ä¸€è‡´æ€§
- [x] **æ¨èç®—æ³•åˆ‡æ¢**ï¼šAI/æœ¬åœ°ç®—æ³•åŠ¨æ€åˆ‡æ¢
- [x] **ç”¨æˆ·ä¸Šä¸‹æ–‡å˜åŒ–**ï¼šæ¨èç¼“å­˜çš„æ™ºèƒ½å¤±æ•ˆ

## ğŸ”§ è°ƒè¯•å’Œç›‘æ§

### 1. è°ƒè¯•ä¿¡æ¯
æ‰€æœ‰ç¼“å­˜æ“ä½œéƒ½åŒ…å«è¯¦ç»†çš„console.logè¾“å‡ºï¼š

```typescript
// ä»»åŠ¡ç¼“å­˜ç›¸å…³æ—¥å¿—
console.log('ğŸ  HomePage: ä¼˜å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½æ•°æ®');
console.log('âœ… HomePage: ä½¿ç”¨ç¼“å­˜æ•°æ®åˆå§‹åŒ–é¡µé¢');
console.log('ğŸ“… TimelinePage: åˆå§‹åŒ–ï¼ŒåŠ è½½å½“å¤©ä»»åŠ¡');
console.log('ğŸ’¾ é¡¹ç›®é¡µé¢: åˆ†ç±»ç¼“å­˜å·²æ›´æ–°', { categoryId, taskCount });

// æ¨èç¼“å­˜ç›¸å…³æ—¥å¿—
console.log('ğŸ¤– å°è¯•ä½¿ç”¨AIæ¨è');
console.log('ğŸ’¾ ä½¿ç”¨ç¼“å­˜çš„æ¨èç»“æœ', { count: 3, method: 'ai', age: '45s' });
console.log('ğŸ“‹ ä»»åŠ¡æ•°æ®å·²å˜åŒ–ï¼Œæ›´æ–°æ¨è');
console.log('ğŸ”„ AIæ¨èå¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°æ¨è');

// è”åŠ¨äº‹ä»¶æ—¥å¿—
console.log('ğŸ“¢ æ”¶åˆ°ä»»åŠ¡ç¼“å­˜æ›´æ–°äº‹ä»¶', event.detail);
console.log('âœ… TaskAddDrawer: å·²å°†æ–°ä»»åŠ¡æ·»åŠ åˆ°æ—¶é—´è½´ç¼“å­˜');
```

### 2. ç¼“å­˜çŠ¶æ€ç›‘æ§
```typescript
// è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
const getCacheStats = () => {
  const stats = {
    taskCache: {
      projectCache: getProjectCacheInfo(),
      timelineCache: getTimelineCacheInfo(),
      hitRate: calculateTaskCacheHitRate()
    },
    recommendationCache: {
      status: getRecommendationCacheStatus(),
      hitRate: calculateRecommendationCacheHitRate(),
      aiSuccessRate: getAiRecommendationSuccessRate()
    },
    totalSize: calculateTotalCacheSize(),
    performance: getPerformanceMetrics()
  };
  return stats;
};
```

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æŠ€æœ¯å‡çº§
- **IndexedDBè¿ç§»**ï¼šæ›¿ä»£sessionStorageå®ç°æŒä¹…åŒ–ç¼“å­˜
- **Service Worker**ï¼šç¦»çº¿ä¼˜å…ˆçš„ç¼“å­˜ç­–ç•¥
- **WebRTCåŒæ­¥**ï¼šå¤šè®¾å¤‡é—´çš„ç¼“å­˜æ•°æ®åŒæ­¥

### 2. æ™ºèƒ½ä¼˜åŒ–
- **é¢„æµ‹æ€§ç¼“å­˜**ï¼šåŸºäºç”¨æˆ·è¡Œä¸ºé¢„åŠ è½½å¯èƒ½è®¿é—®çš„æ•°æ®
- **è‡ªé€‚åº”è¿‡æœŸ**ï¼šæ ¹æ®æ•°æ®å˜åŒ–é¢‘ç‡åŠ¨æ€è°ƒæ•´ç¼“å­˜æ—¶é—´
- **å‹ç¼©å­˜å‚¨**ï¼šæ•°æ®å‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´å ç”¨
- **æœºå™¨å­¦ä¹ æ¨è**ï¼šåŸºäºå†å²æ•°æ®ä¼˜åŒ–æ¨èç®—æ³•
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šæ ¹æ®æ—¶é—´ã€åœ°ç‚¹ã€ç”¨æˆ·çŠ¶æ€è°ƒæ•´æ¨èç­–ç•¥

### 3. ç›‘æ§å®Œå–„
- **æ€§èƒ½æŒ‡æ ‡ä¸ŠæŠ¥**ï¼šç¼“å­˜å‘½ä¸­ç‡ã€åŠ è½½æ—¶é—´ç­‰æŒ‡æ ‡ç›‘æ§
- **å¼‚å¸¸å‘Šè­¦**ï¼šç¼“å­˜å¼‚å¸¸æƒ…å†µçš„è‡ªåŠ¨æŠ¥å‘Š
- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šåŸºäºç¼“å­˜ä½¿ç”¨æƒ…å†µä¼˜åŒ–äº§å“åŠŸèƒ½
- **A/Bæµ‹è¯•æ”¯æŒ**ï¼šä¸åŒç¼“å­˜ç­–ç•¥çš„æ•ˆæœå¯¹æ¯”

## ğŸ“ å¼€å‘è§„èŒƒ

### 1. ç¼“å­˜é”®å‘½åè§„èŒƒ
```typescript
// ä»»åŠ¡ç¼“å­˜æ ¼å¼ï¼š{é¡µé¢å‰ç¼€}-{æ•°æ®ç±»å‹}-{å”¯ä¸€æ ‡è¯†}
const PROJECT_TASKS = 'project-category-tasks-{categoryId}';
const TIMELINE_TASKS = 'timeline-tasks-{yyyy-MM-dd}';

// æ¨èç¼“å­˜æ ¼å¼ï¼š{åŠŸèƒ½}-{ç±»å‹}
const HOME_RECOMMENDATIONS = 'homepage-recommendations';
const RECOMMENDATION_METADATA = 'homepage-recommendations-metadata';
```

### 2. ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **åˆ›å»º**ï¼šæ•°æ®åŠ è½½æˆåŠŸåç«‹å³ç¼“å­˜
- **æ›´æ–°**ï¼šæ•°æ®å˜æ›´æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜
- **è”åŠ¨**ï¼šç›¸å…³ç¼“å­˜ç³»ç»Ÿçš„è‡ªåŠ¨é€šçŸ¥æœºåˆ¶
- **æ¸…ç†**ï¼šé¡µé¢å¸è½½æˆ–è¿‡æœŸæ—¶æ¸…ç†ç›¸å…³ç¼“å­˜
- **éªŒè¯**ï¼šä½¿ç”¨å‰æ£€æŸ¥ç¼“å­˜æœ‰æ•ˆæ€§

### 3. é”™è¯¯å¤„ç†æ ‡å‡†
```typescript
const handleCacheError = (error: Error, context: string) => {
  console.error(`ç¼“å­˜æ“ä½œå¤±è´¥ [${context}]:`, error);
  
  // æ ¹æ®ç¼“å­˜ç±»å‹é€‰æ‹©é™çº§ç­–ç•¥
  if (context.includes('recommendation')) {
    // æ¨èç¼“å­˜å¤±è´¥ - é™çº§åˆ°æœ¬åœ°ç®—æ³•
    return generateLocalRecommendations();
  } else {
    // ä»»åŠ¡ç¼“å­˜å¤±è´¥ - é™çº§åˆ°APIè°ƒç”¨
    return loadFromApi();
  }
};
```

## ğŸ”— ç›¸å…³æ–‡æ¡£é“¾æ¥

- [APIæ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md)
- [ä»»åŠ¡ç±»å‹ä¸ä»»åŠ¡ç±»åˆ«è¯¦ç»†è§£æ](./ä»»åŠ¡ç±»å‹ä¸ä»»åŠ¡ç±»åˆ«è¯¦ç»†è§£æ.md)
- [é¦–é¡µæ¨èåŠŸèƒ½å®Œæ•´æŒ‡å—](./é¦–é¡µæ¨èåŠŸèƒ½å®Œæ•´æŒ‡å—.md)
- [å‰ç«¯æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ](../README.md)

---

*æœ€åæ›´æ–°æ—¶é—´ï¼š2024-12-19*  
*æ–‡æ¡£ç‰ˆæœ¬ï¼šv3.0*  
*ç»´æŠ¤è€…ï¼šé¡¹ç›®å›¢é˜Ÿ* 